<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ripple Platform • Demo</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#111826; --panel-2:#0f1723;
      --ink:#e6eef9; --muted:#99a7bd;
      --brand:#7bd7ff; --brand-2:#7b9cff; --accent:#5bffbf;
      --danger:#ff7b9e; --warn:#ffd27b; --success:#79ffa3;
      --shadow:0 10px 40px rgba(0,0,0,.35); --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(123,156,255,.25), transparent 60%),
        radial-gradient(1200px 800px at 110% 10%, rgba(123,215,255,.15), transparent 60%),
        var(--bg);
      letter-spacing:.2px;
    }
    a{color:var(--brand)}
    .wrap{max-width:1200px;margin:0 auto;padding:32px}

    /* Header */
    .nav{display:flex;align-items:center;justify-content:space-between;padding:12px 0 28px}
    .brand{display:flex;align-items:center;gap:12px;font-weight:700;font-size:20px}
    .logo{width:36px;height:36px;border-radius:12px;background:conic-gradient(from 210deg, var(--brand), var(--brand-2), var(--accent), var(--brand));filter:drop-shadow(0 6px 18px rgba(123,156,255,.45));position:relative;overflow:hidden}
    .logo::after{content:"";position:absolute;inset:6px;border-radius:10px;background:rgba(11,15,20,.9)}
    .logo::before{content:"";position:absolute;inset:0;border-radius:12px;border:2px solid rgba(255,255,255,.12)}
    .nav .actions{display:flex;gap:10px}
    .btn{appearance:none;border:none;cursor:pointer;border-radius:14px;padding:10px 14px;font-weight:600;color:#0b0f14;background:var(--ink)}
    .btn.secondary{background:#172233;color:var(--ink);border:1px solid rgba(255,255,255,.08)}

    /* Hero */
    .hero{display:grid;grid-template-columns:1.3fr .9fr;gap:24px;align-items:stretch}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);box-shadow:var(--shadow);border-radius:var(--radius)}
    .pad{padding:22px}
    h1{margin:.2em 0 .35em;font-size:40px;line-height:1.05;letter-spacing:.2px}
    .lede{color:var(--muted);max-width:60ch}

    /* Inputs */
    .uploader{display:grid;grid-template-columns:1fr;gap:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .input{flex:1;min-width:220px;background:#0f1723;border:1px solid rgba(255,255,255,.08);border-radius:12px;color:var(--ink);padding:12px 14px}
    .textarea{min-height:140px;resize:vertical;line-height:1.4}
    .chipbar{display:flex;flex-wrap:wrap;gap:10px;margin-top:2px}
    .chip{padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#0f1723;color:var(--ink);font-weight:600;cursor:pointer;position:relative}
    .chip input{position:absolute;opacity:0;inset:0;cursor:pointer}
    .chip.active{border-color:var(--brand);box-shadow:0 0 0 3px rgba(123,156,255,.18)}

    /* File (minimized) */
    .file-toggle{display:flex;align-items:center;gap:10px;background:#0f1723;border:1px dashed rgba(255,255,255,.14);padding:12px 14px;border-radius:12px;cursor:pointer}
    .file-toggle:hover{border-color:var(--brand)}
    .file-toggle .badge{font-size:11px;font-weight:800;color:#06101a;background:linear-gradient(90deg,var(--brand-2),var(--brand));padding:6px 8px;border-radius:999px}
    .drop{border:2px dashed rgba(255,255,255,.16);border-radius:16px;padding:22px;display:flex;gap:14px;align-items:center;justify-content:center;min-height:140px;transition:.2s;background:linear-gradient(180deg, rgba(123,156,255,.07), rgba(123,215,255,.03))}
    .drop.drag{border-color:var(--brand);box-shadow:0 0 0 4px rgba(123,156,255,.15) inset}
    .drop .hint{color:var(--muted)}
    .hidden{display:none}

    /* Right rail */
    .rail{display:flex;flex-direction:column;gap:16px}
    .how{font-size:14px;color:var(--muted);line-height:1.6}

    /* Analyze bar */
    .analyze-bar{display:flex;gap:12px;align-items:center;justify-content:flex-end;margin-top:8px}
    .btn.glow{background:linear-gradient(90deg, var(--brand-2), var(--brand));color:#07101a;position:relative}
    .btn.glow::after{content:"";position:absolute;inset:-2px;border-radius:16px;box-shadow:0 10px 30px rgba(123,156,255,.55);opacity:.9}

    /* Results */
    .results{margin-top:28px;display:grid;grid-template-columns:repeat(12,1fr);gap:18px}
    .tile{grid-column:span 4;background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px;min-height:160px}
    .tile h3{margin:0 0 8px;font-size:16px;color:#cfe0ff}
    .metric{display:flex;align-items:center;gap:14px}
    .tile .section{margin-top:12px;padding-top:10px;border-top:1px dashed rgba(255,255,255,.08)}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:8px 12px;font-size:13px;color:var(--muted)}
    .kv .k{color:#cfe0ff}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .b-true{background:rgba(121,255,163,.14);color:var(--success);border:1px solid rgba(121,255,163,.25)}
    .b-false{background:rgba(255,123,158,.14);color:var(--danger);border:1px solid rgba(255,123,158,.25)}
    .b-unclear{background:rgba(123,156,255,.14);color:var(--brand-2);border:1px solid rgba(123,156,255,.25)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    /* Gauge */
    .gauge{--v:0;width:86px;aspect-ratio:1;border-radius:50%;position:relative;background:conic-gradient(var(--brand) calc(var(--v)*1%), rgba(255,255,255,.12) 0);box-shadow:inset 0 0 0 10px #0d1421, 0 10px 30px rgba(0,0,0,.4)}
    .gauge::after{content:attr(data-label);position:absolute;inset:10px;display:grid;place-items:center;background:#0d1421;border-radius:50%;color:#dbe8ff;font-size:15px;font-weight:700}
    .metric .value{font-size:28px;font-weight:800}
    .metric .desc{color:var(--muted);font-size:13px}

    /* Footer */
    footer{opacity:.7;color:var(--muted);font-size:12px;text-align:center;margin:30px 0}

    @media (max-width:980px){.hero{grid-template-columns:1fr}.tile{grid-column:span 6}}
    @media (max-width:640px){.tile{grid-column:span 12}h1{font-size:34px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="nav">
      <div class="brand"><div class="logo" aria-hidden="true"></div><div>Ripple Lab</div></div>
      <div class="actions">
        <button class="btn secondary" id="btn-gallery">Gallery</button>
        <button class="btn secondary" id="btn-docs">Docs</button>
        <button class="btn">Sign in</button>
      </div>
    </header>

    <section class="hero">
      <div class="card pad">
        <h1>Paste text. Pick a Ripple. <br/>See the wave.</h1>
        <p class="lede">Start by pasting text (or a URL). Uploads are optional. This demo simulates the engine and renders interactive result cards—nothing leaves your browser.</p>

        <div class="uploader" aria-label="Submission form">
          <label for="text" style="font-weight:700">Your text</label>
          <textarea id="text" class="input textarea" rows="6" placeholder="Paste or type text here…" aria-label="Text input"></textarea>

          <div class="row">
            <input id="url" class="input" placeholder="Optional: https://example.com/article-or-post" aria-label="URL input"/>
          </div>

          <div>
            <div style="font-weight:700;margin-bottom:8px">Choose Ripple tools</div>
            <div class="chipbar" id="chips"></div>
          </div>

          <div id="file-toggle" class="file-toggle" role="button" aria-controls="drop" aria-expanded="false">
            <span class="badge">Optional</span><span>Add files (image / audio / text)…</span>
          </div>

          <div id="drop" class="drop hidden" tabindex="0" role="button" aria-label="Drag & drop files here or click to browse">
            <div><strong>Drag & drop</strong> files here or <u>click to browse</u>
              <div class="hint">You can also paste a URL above. No files leave your browser in this demo.</div>
            </div>
            <input type="file" id="file" multiple hidden />
          </div>

          <div class="analyze-bar">
            <span id="mode-badge" class="badge b-unclear" title="Toggle in code: USE_MOCK">Model mode</span>
            <span id="hint" style="color:var(--muted);font-size:13px;margin-left:auto">Ready.</span>
            <button id="analyze" class="btn glow">Analyze</button>
          </div>
        </div>
      </div>

      <aside class="rail">
        <div class="card pad">
          <div style="font-weight:800;margin-bottom:10px">How it works</div>
          <ol class="how">
            <li>Paste text (or a link) to analyze.</li>
            <li>Optionally add files: images (OCR), audio (transcribe), text docs.</li>
            <li>Select Ripple tool(s) — Truth, Score, Align, Seer, Physco, Wisdom.</li>
            <li>Run algorithms → produce scores, narratives, and visualizations.</li>
          </ol>
        </div>
        <div class="card pad">
          <div style="font-weight:800;margin-bottom:10px">Privacy</div>
          <p class="how">This is a local demo. In production, results are versioned and shareable with optional redaction for PII.</p>
        </div>
      </aside>
    </section>

    <section id="results" class="results" aria-live="polite"></section>

    <footer>© Ripple Lab • Demo UI. Built for speed, clarity, and vibes.</footer>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const USE_MOCK = false; // live calls
    const API_ENDPOINT_PRIMARY = '/api/ripple/analyze';
    const API_ENDPOINT_FALLBACK = '/api/analyze';

    // =========================
    // Tool registry
    // =========================
    const TOOLS = [
      {key:'RippleTruth', color:'var(--success)', desc:'Veracity–intention gradient of content.'},
      {key:'RippleScore', color:'var(--brand)', desc:'Polarization amplitude & emotional energy.'},
      {key:'RippleAlign', color:'var(--accent)', desc:'Alignment between intention and field flow.'},
      {key:'RippleSeer', color:'var(--warn)', desc:'Momentum of intention; ignition likelihood.'},
      {key:'RipplePhysco', color:'var(--danger)', desc:'Symbolic charge vs semantic clarity.'},
      {key:'RippleWisdom', color:'var(--brand-2)', desc:'Coherence slope over time.'}
    ];

    fetch('/api/ripple/analyze', {
  method: 'POST',
  headers: {'Content-Type':'application/json'},
  body: JSON.stringify({ text, url, tools: ['RippleTruth'] })
})



    // Chips
    const chipbar = document.getElementById('chips');
    TOOLS.forEach(t=>{
      const chip = document.createElement('label');
      chip.className = 'chip';
      chip.innerHTML = `<input type="checkbox" value="${t.key}"><span style="display:inline-flex;gap:8px;align-items:center"><span style="width:10px;height:10px;border-radius:50%;background:${t.color};box-shadow:0 0 0 3px rgba(255,255,255,.06) inset"></span>${t.key}</span>`;
      chip.title = t.desc;
      chip.addEventListener('change', ()=> chip.classList.toggle('active', chip.querySelector('input').checked));
      chipbar.appendChild(chip);
    });

    // Optional upload reveal
    const drop = document.getElementById('drop');
    const fileToggle = document.getElementById('file-toggle');
    const fileInput = document.getElementById('file');
    fileToggle.addEventListener('click', ()=>{
      const open = drop.classList.toggle('hidden');
      const expanded = !open;
      fileToggle.setAttribute('aria-expanded', String(expanded));
      if (expanded) setTimeout(()=>drop.focus(), 0);
    });
    drop.addEventListener('click', ()=> fileInput.click());
    drop.addEventListener('dragover', e=>{e.preventDefault(); drop.classList.add('drag');});
    drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
    drop.addEventListener('drop', e=>{
      e.preventDefault(); drop.classList.remove('drag');
      const files = [...e.dataTransfer.files];
      if(files.length){ document.getElementById('hint').textContent = `${files.length} file(s) ready`; }
    });
    fileInput.addEventListener('change', ()=>{
      const files = [...fileInput.files];
      if(files.length){ document.getElementById('hint').textContent = `${files.length} file(s) ready`; }
    });

    // =========================
    // Helpers
    // =========================
    const resultsEl = document.getElementById('results');
    const analyzeBtn = document.getElementById('analyze');
    const hint = document.getElementById('hint');
    const modeBadge = document.getElementById('mode-badge');
    modeBadge.textContent = USE_MOCK ? 'Demo mode' : 'Model mode';
    modeBadge.className = `badge ${USE_MOCK ? 'b-unclear' : 'b-true'}`;

    function scoreFromText(text){
      const len = text.length || 1;
      const p = (text.match(/[!?,.]/g)||[]).length;
      return Math.min(100, Math.max(6, Math.round((Math.log(len+10)*9 + p*2) % 100)));
    }

    function gauge(value){
      const v = Math.max(0, Math.min(100, Number(value)||0));
      return `<div class="metric">
        <div class="gauge" data-label="${v}%" style="--v:${v}"></div>
        <div>
          <div class="value">${v}<span style="font-size:14px;opacity:.6">/100</span></div>
          <div class="desc"> </div>
        </div>
      </div>`;
    }

    function tileShell(title, inner){
      const div = document.createElement('div');
      div.className = 'tile';
      div.innerHTML = `<h3>${title}</h3>${inner}`;
      return div;
    }

    // -------------------------
    // Tools payload normalizer:
    //  - supports {tools: {RippleTruth: {...}}}
    //  - and {tools: [{tool:"RippleTruth", score:..}]}
    // -------------------------
    function normalizeTools(payload){
      const t = payload?.tools;
      if (!t) return {};
      if (Array.isArray(t)){
        const map = {};
        t.forEach(item=>{
          if (!item?.tool) return;
          // keep original fields; alias 'note' -> 'summary' for generic rendering
          map[item.tool] = { ...item, summary: item.note };
        });
        return map;
      }
      return t; // already an object map
    }

    // =========================
    // Renderers
    // =========================
    function renderTruth(data){
      // expects rich shape when available:
      // { score, verdict, claims[], rationale, highlights[], report:{headline, definition, eq, metrics[], narrative[]} }
      const v = Number(data?.score ?? 0);
      const verdict = (data?.verdict || 'Unclear');
      const badgeClass = verdict === 'True' ? 'b-true' : verdict === 'False' ? 'b-false' : 'b-unclear';

      // Report details (optional)
      const r = data?.report || {};
      const headline = r.headline ? `<div class="section"><div class="kv"><div class="k">Headline</div><div>${r.headline}</div></div></div>` : '';
      const definition = r.definition ? `<div class="section"><div class="kv"><div class="k">Definition</div><div>${r.definition}</div></div></div>` : '';
      const equation = r.eq ? `<div class="section"><div class="kv"><div class="k">Formal</div><div class="mono">${r.eq}</div></div></div>` : '';

      let metrics = '';
      if (Array.isArray(r.metrics) && r.metrics.length){
        const rows = r.metrics.map(m=>`
          <div class="kv"><div class="k">${m.name}</div><div>${m.value} — <span style="opacity:.75">${m.meaning || ''}</span></div></div>
        `).join('');
        metrics = `<div class="section"><div class="kv"><div class="k">Metrics</div><div></div></div>${rows}</div>`;
      }

      let narrative = '';
      if (Array.isArray(r.narrative) && r.narrative.length){
        narrative = `<div class="section"><div class="kv"><div class="k">Narrative</div><div>${r.narrative.map(p=>`<p style="margin:.3em 0">${p}</p>`).join('')}</div></div></div>`;
      }

      // Claims (if present)
      let claimsBlock = '';
      if (Array.isArray(data?.claims) && data.claims.length){
        const lines = data.claims.map(c=>{
          const val = (c.value !== undefined && c.value !== null) ? `<span style="opacity:.7">(${c.value})</span>` : '';
          const conf = (c.confidence != null) ? ` — conf ${(Number(c.confidence)||0).toFixed(2)}` : '';
          return `• ${c.text} ${val}${conf}`;
        }).join('<br/>');
        claimsBlock = `
          <div class="section">
            <div class="kv" style="margin-bottom:6px">
              <div class="k">Detected claims</div><div></div>
            </div>
            <div class="mono" style="font-size:12px;opacity:.9">${lines}</div>
          </div>`;
      }

      const rationale = data?.rationale ? `
        <div class="section"><div class="kv"><div class="k">Rationale</div><div>${data.rationale}</div></div></div>` : '';

      const highlights = Array.isArray(data?.highlights) && data.highlights.length ? `
        <div class="section"><div class="kv"><div class="k">Highlights</div>
          <div class="mono" style="font-size:12px">
            ${data.highlights.map(h=>`<mark style="background:rgba(123,156,255,.15);padding:2px 4px;border-radius:6px">${h.span}</mark> <span style="opacity:.7">— ${h.reason||''}</span>`).join('<br/>')}
          </div></div>
        </div>` : '';

      const meta = `
        <div class="section">
          <div class="kv">
            <div class="k">Verdict</div><div><span class="badge ${badgeClass}">${verdict}</span></div>
            <div class="k">Score</div><div>${v} / 100</div>
          </div>
        </div>`;

      // If backend is still basic (no report/claims), you'll still get a nice card with score + rationale
      return tileShell('RippleTruth', `${gauge(v)}${meta}${headline}${definition}${equation}${metrics}${narrative}${claimsBlock}${rationale}${highlights}`);
    }

    function renderGeneric(name, data){
      const v = Number(data?.score ?? scoreFromText(data?.text || ''));
      const summary = data?.summary || data?.note || '—';
      return tileShell(name, `${gauge(v)}<div class="section"><div class="kv"><div class="k">Summary</div><div>${summary}</div></div></div>`);
    }

    // =========================
    // Mock generator (kept for dev toggling)
    // =========================
    function mockAnalyze({text, url, tools}){
      const base = scoreFromText(text + ' ' + (url||''));
      const jitter = k => Math.max(6, Math.min(98, Math.round((base*0.6 + Math.floor((Math.sin(base + k*42)*50 + 50))*0.5) % 100)));
      const out = { run_id: `demo_${Date.now()}`, mode: 'demo', tools: {} };
      tools.forEach((t,i)=>{
        if (t === 'RippleTruth'){
          out.tools.RippleTruth = {
            score: jitter(i),
            verdict: 'Unclear',
            claims: [],
            rationale: 'Insufficient explicit claims detected to assign a definitive verdict in demo mode.',
            highlights: [],
            // no report in demo
          };
        } else {
          out.tools[t] = { score: jitter(i), summary: 'Demo summary.' };
        }
      });
      return new Promise(res=>setTimeout(()=>res(out), 450));
    }

    // =========================
    // Backend call (model mode)
    // =========================
    async function callModel({text, url, tools}){
      // try primary then fallback route to match your Flask
      const body = JSON.stringify({ text, url, tools });
      const headers = {'Content-Type':'application/json'};

      let resp = await fetch(API_ENDPOINT_PRIMARY, {method:'POST', headers, body});
      if (!resp.ok){
        // try fallback if 404/405/etc
        const alt = await fetch(API_ENDPOINT_FALLBACK, {method:'POST', headers, body});
        if (!alt.ok) throw new Error(`API ${resp.status} and fallback ${alt.status}`);
        resp = alt;
      }
      return resp.json();
    }

    function renderResults(payload, tools){
      resultsEl.innerHTML = '';
      const toolMap = normalizeTools(payload);
      tools.forEach(key=>{
        const data = toolMap[key] || {};
        let node;
        if (key === 'RippleTruth') node = renderTruth(data);
        else node = renderGeneric(key, data);
        resultsEl.appendChild(node);
      });
    }

    // =========================
    // Analyze button
    // =========================
    analyzeBtn.addEventListener('click', async ()=>{
      const chosen = [...document.querySelectorAll('.chip input:checked')].map(i=>i.value);
      if(!chosen.length) chosen.push('RippleTruth','RipplePhysco');

      const text = (document.getElementById('text').value || '').trim();
      const url = (document.getElementById('url').value || '').trim();

      hint.textContent = 'Analyzing…';
      resultsEl.innerHTML = '';

      try{
        const payload = USE_MOCK
          ? await mockAnalyze({text, url, tools: chosen})
          : await callModel({text, url, tools: chosen});
        renderResults(payload, chosen);
        hint.textContent = 'Done.';
      }catch(err){
        console.error(err);
        hint.textContent = 'Error.';
        const errNode = document.createElement('div');
        errNode.className = 'tile';
        errNode.innerHTML = `<h3>Analysis error</h3><div class="section"><div class="kv"><div class="k">Message</div><div class="mono">${String(err)}</div></div></div>`;
        resultsEl.appendChild(errNode);
      }
    });
  </script>
</body>
</html>



